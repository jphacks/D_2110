<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>生物学的構造単位生成器</title>
  <meta name="description" content="This is an example of a meta description.">
  <link rel="stylesheet" href="css/LiteMol-plugin.css" type="text/css" />
  <script src="js/LiteMol-plugin.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>
</head>

<body>
  <form>
    <div>
      <input type="text" name="pdb_code" id="pdb_code">
      <input type="submit" id="submit_button">
      <p id="result"></p>
    </div>
  </form>
  <div>
    <table>
      <thead>
        <tr>
          <th>PDB code</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>5V8K</td>
          <td>二量体</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div id="litemol_before" style="width: 640px; height: 480px; margin-top: 200px; position: relative"></div>
  <div id="litemol_after" style="width: 640px; height: 480px; margin-top: 200px; position: relative"></div>
  <script>
    function load_structure(plugin, pdb_code, url) {
      plugin.loadMolecule({
        id: pdb_code,
        url,
        format: 'pdb'
      }).then(() => {
        console.log(`Molecule loaded from: ${url}`)
      }).catch(error => {
        console.error(error)
      })
    }

    const plugin1 = LiteMol.Plugin.create({ target: '#litemol_before' });
    const plugin2 = LiteMol.Plugin.create({ target: '#litemol_after' });

    const api_url = 'https://us-central1-jphack-d-2110.cloudfunctions.net/fetch_biological_assembly'

    $("#submit_button").click(event => {
      event.preventDefault()
      const pdb_code = $('#pdb_code').val()
      if ($("input").first().val().length === 4) {
        $("#result").text("Assembling now. This takes about 10 seconds.").show()
        $.ajax({
          url: api_url,
          dataType: 'json',
          type: 'post',
          contentType: 'application/json',
          data: JSON.stringify({ pdb_code }),
          success: function (data, textStatus, jQxhr) {
            load_structure(plugin1, pdb_code, data.original_url)
            load_structure(plugin2, pdb_code, data.assembly_url)
            $("#result").text("Done").show()
          },
          fail: function (jqXHR, textStatus, errorThrown) {
            $("#result").text("Request fail").show()
            console.error(`Status is: ${textStatus}. Error message is: ${errorThrown}`)
          }
        })

      } else {
        $("#result").text("PDB code must be 4 char.").show()
      }
      return true;
    })
  </script>
</body>

</html>